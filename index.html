<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <meta charset="UTF-8" />
  <title>Curso de Sueco</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#121212;--surface:#1e1e1e;--text:#e0e0e0;--primary:#bb86fc;--accent:#03dac6;--rad:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:1rem}
    h1,h2{color:var(--primary)}
    section{background:var(--surface);border-radius:var(--rad);padding:1rem 1.5rem;margin-bottom:2rem;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    button{background:var(--primary);color:var(--text);border:none;padding:.5rem 1rem;border-radius:var(--rad);cursor:pointer;font-size:1rem;margin-top:.5rem}
    button:hover{background:var(--accent)}
    .hidden{display:none}
    .item{margin-bottom:.9rem}
    .example{font-style:italic;font-size:.95rem}
    .example strong{color:var(--accent)}
    .note{margin:0 0 .5rem;color:var(--accent);font-size:.9rem}
    #finish-btn{display:block;margin:2rem auto}
    #status{color:var(--accent);margin-bottom:1rem;min-height:1.4em}
    #review-list{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    #chat-box{max-height:220px;overflow-y:auto;padding:1rem;border:1px solid #555;border-radius:var(--rad);background:var(--surface);font-size:.95rem;margin-bottom:1rem}
    #chat-box div{margin-bottom:.5rem}
    .speak{cursor:pointer;margin-left:.4rem}
    #dict-box{column-count:4;column-gap:1rem}
    #clear-dict{background:#e35353}
    /* Bot√≥n de tema flotante */
    #theme-btn {
      position: fixed;
      top: 18px;
      right: 70px; /* separado del bot√≥n de ayuda */
      z-index: 2000;
      background: var(--surface);
      color: var(--primary);
      border: none;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      font-size: 1.3rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      pointer-events: auto;
    }
    #theme-btn:hover { background: var(--primary); color: var(--surface); }
    /* Popover de tema */
    #theme-popover {
      position: fixed;
      top: 62px;
      right: 18px;
      z-index: 2100;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--rad);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      padding: .75rem;
      width: 220px;
      font-size: .95rem;
    }
    #theme-popover h4 { margin: 0 0 .5rem 0; color: var(--primary); font-size: 1rem; }
    .theme-option { display: flex; align-items: center; gap: .5rem; padding: .4rem .35rem; border-radius: 8px; cursor: pointer; }
    .theme-option:hover { background: rgba(255,255,255,0.06); }
    .theme-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(0,0,0,.15); box-shadow: inset 0 0 0 2px rgba(255,255,255,.3); }
    .theme-label { flex: 1; }
    .theme-active { outline: 2px solid var(--primary); }
    /* Ayuda flotante */
    #help-btn {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 2000;
      background: var(--surface);
      color: var(--primary);
      border: none;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      pointer-events: auto;
    }
    #help-btn:hover {
      background: var(--primary);
      color: var(--surface);
    }
    #help-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      background: var(--surface);
      color: var(--text);
      border-radius: var(--rad);
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
      padding: 2.5rem 2rem 2rem 2rem;
      max-width: 95vw;
      width: 50vw;  /* 50% del ancho de la ventana */
      min-width: 370px; /* m√≠nimo para m√≥viles */
      max-width: 800px; /* m√°ximo para pantallas muy grandes */
      font-size: 1.05rem;
      display: none;
    }
    #help-modal.visible { display: block; }
    #help-modal h3 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.2rem;
    }
    #help-modal ul { margin: 0 0 0.5em 1.2em; padding: 0; }
    #help-modal button.close-help {
      position: absolute;
      top: 10px;
      right: 14px;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.7rem;
      cursor: pointer;
      line-height: 1;
      width: 2.2em;
      height: 2.2em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (max-width:600px){
      body{padding:.5rem}
      section{padding:.75rem 1rem;margin-bottom:1.2rem}
      h1{font-size:1.4rem;text-align:center}
      h2{font-size:1.1rem}
      #review-list{grid-template-columns:1fr}
      button{width:100%}
      #help-modal {
        width: 95vw;
        min-width: unset;
        max-width: 95vw;
        padding: 3.2rem 1rem 1.5rem 1rem;
        font-size: 1rem;
      }
      #help-btn {
        top: 10px;
        right: 10px;
        width: 44px;
        height: 44px;
        font-size: 1.7rem;
      }
      #theme-btn { top: 10px; right: 62px; width: 44px; height: 44px; font-size: 1.6rem; }
      #theme-popover { top: 60px; right: 10px; width: calc(95vw - 20px); }
      #help-modal button.close-help {
        top: 10px;
        right: 10px;
        font-size: 2rem;
        width: 2.2em;
        height: 2.2em;
      }
    }
  </style>
</head>
<body>
<h1>Curso de Sueco</h1>
<p id="status"></p>
<p id="debug-status" style="color:var(--accent);margin-top:0.5rem;font-size:0.9rem;"></p>

<section><h2>Vocabulario</h2><p class="note">Copia 10 veces cada palabra en tu cuaderno para aprenderlas.</p><div id="vocab-list"></div></section>
<section><h2>Ejercicios</h2><p class="note">Traduce al sueco en tu cuaderno y, si encuentras palabras que no conoces, c√≥pialas diez veces para aprenderlas.</p><div id="grammar-explanation" style="background:var(--surface);padding:1rem;border-radius:var(--rad);margin-bottom:1rem;border-left:4px solid var(--primary);"></div><div id="exercise-list"></div></section>
<section><h2>Repaso</h2><p class="note">Traduce estas palabras al sueco en tu cuaderno y, si alguna no te la sabes, c√≥piala diez veces para aprenderla.</p><div id="review-list"></div></section>

<section>
  <h2>Chat con tu profesor virtual</h2>
  <div id="chat-box"></div>
  <input id="chat-input" placeholder="Escribe tu pregunta‚Ä¶" style="width:100%;padding:.5rem;border-radius:var(--rad);border:1px solid var(--primary);background:var(--surface);color:var(--text)">
  <button id="chat-send">Enviar</button>
</section>

<button id="finish-btn">Dar por terminada la lecci√≥n</button>
<!-- Bot√≥n developer para generar 150 sesiones -->
<!-- <button id="dev-run" style="position:fixed;bottom:18px;right:18px;z-index:3000;opacity:.25">DEBUG</button> -->


<section id="level-section" style="background:var(--surface);border-radius:var(--rad);padding:1rem 1.5rem;margin-bottom:2rem;box-shadow:0 4px 12px rgba(0,0,0,.5)">
  <div style="margin-bottom:.7rem">
    <button id="level-current-btn" style="all:unset;cursor:pointer;color:var(--primary);font-weight:bold;font-size:1.1em;">Nivel actual: <span id="level-current"></span></button>
  </div>
  <div style="margin-bottom:.7rem;display:flex;gap:.5rem;flex-wrap:wrap;">
    <button id="level-next-btn">Avanzar nivel</button>
    <button id="level-toggle-select">Selecciona nivel</button>
  </div>
  <div style="margin-bottom:.7rem;display:flex;gap:.5rem;flex-wrap:wrap;">
    <button id="mode-repaso" style="background:#90EE90;color:#333;border:none;padding:.5rem 1rem;border-radius:var(--rad);cursor:pointer;font-size:.9rem;font-weight:bold;">Modo Repaso</button>
    <button id="mode-reforzar" style="background:#4a4a4a;color:#ccc;border:1px solid var(--primary);padding:.5rem 1rem;border-radius:var(--rad);cursor:pointer;font-size:.9rem;">Modo Reforzar Nivel</button>
  </div>
  <div id="level-select-wrap" class="hidden" style="margin-top:.7rem">
    <div class="note">Pulsa en Guardar y terminar lecci√≥n para guardar tu elecci√≥n</div>
    <div id="level-radio-list" style="margin-bottom:.7rem"></div>
    <button id="level-save-btn">Guardar y terminar lecci√≥n</button>
  </div>
</section>

<!-- ---------- Diccionario completo ---------- -->
<section id="dict-section">
  <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
    <button id="show-dict">Ver diccionario completo</button>
    <button id="clear-dict" class="hidden">Borrar diccionario</button>
  </div>
  <div id="dict-box" class="hidden" style="margin-top:.8rem;white-space:pre-wrap;font-size:.95rem"></div>
</section>

<!-- ---------- Sobre la aplicaci√≥n ---------- -->
<section id="about-section">
  <h2 style="margin-bottom:0">
    <button id="toggle-about" style="all:unset;cursor:pointer;color:var(--primary)">‚ñ∏ Sobre la aplicaci√≥n</button>
  </h2>
 <div id="about-text" class="hidden" style="margin-top:.5rem">
  <p>
    <strong>Curso de Sueco</strong> es una aplicaci√≥n educativa creada por <strong>Emilio Rodr√≠guez</strong>.<br>
    Utiliza Inteligencia Artificial para sugerir vocabulario y ejercicios de sueco de manera personalizada.<br>
    El objetivo es que puedas aprender y practicar sueco de forma sencilla, pr√°ctica y a tu ritmo.<br>
    <br>
    Si tienes cualquier duda, sugerencia o comentario, puedes enviarlo a continuaci√≥n. ¬°Tu opini√≥n es muy valiosa para seguir mejorando la aplicaci√≥n!
  </p>
  <div style="margin-top: 20px;">
    <label for="sugerencia">¬øTienes alguna sugerencia o comentario?</label><br>
    <textarea id="sugerencia" rows="1" style="width: 100%;"></textarea><br>
    <button onclick="enviarSugerencia()">Enviar sugerencia</button>
    <p id="mensaje-enviado" style="color: green; display: none;">‚úÖ ¬°Gracias por tu sugerencia!</p>
  </div>
</div>
</section>

<!-- Bot√≥n de ayuda flotante -->
<button id="help-btn" title="¬øC√≥mo funciona?" onclick="openHelpModal(event)" ontouchend="openHelpModal(event)">?</button>
  <!-- Bot√≥n de tema flotante -->
  <button id="theme-btn" title="Tema de colores" aria-haspopup="true" aria-expanded="false">üé®</button>
  <!-- Popover selecci√≥n de tema -->
  <div id="theme-popover" class="hidden" role="menu" aria-label="Seleccionar tema">
    <h4>Tema de colores</h4>
    <div class="theme-option" data-theme="dark" role="menuitem">
      <span class="theme-dot" style="background:#121212;border-color:#666"></span>
      <span class="theme-label">Modo oscuro</span>
    </div>
    <div class="theme-option" data-theme="red" role="menuitem">
      <span class="theme-dot" style="background:#ff8a80"></span>
      <span class="theme-label">Rojo</span>
    </div>
    <div class="theme-option" data-theme="green" role="menuitem">
      <span class="theme-dot" style="background:#a5d6a7"></span>
      <span class="theme-label">Verde</span>
    </div>
    <div class="theme-option" data-theme="blue" role="menuitem">
      <span class="theme-dot" style="background:#90caf9"></span>
      <span class="theme-label">Azul</span>
    </div>
  </div>
<!-- Modal de ayuda (mover justo antes de </body>) -->
<div id="help-modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
  <button class="close-help" title="Cerrar ayuda">&times;</button>
  <h3 id="help-title">¬øC√≥mo usar la aplicaci√≥n?</h3>
  <ul>
    <li>En tu <strong>cuaderno</strong>, aprende el vocabulario, haz los ejercicios y el repaso que aparece en cada lecci√≥n.</li>
    <li>Usa el <strong>chat</strong> para preguntar dudas a tu profesor virtual sobre gram√°tica, vocabulario y cualquier cosa que necesites.</li>
    <li>Pulsa el icono <span style="color:var(--accent)">üîä</span> para escuchar la pronunciaci√≥n en sueco.</li>
    <li>Pulsa <strong>"Dar por terminada la lecci√≥n"</strong> para guardar tu progreso y vocabulario.</li>
    <li><strong>Selecciona tu nivel</strong> con el bot√≥n "Selecciona nivel" o avanza con "Avanzar nivel".</li>
  </ul>

  <h4 style="color:var(--primary);margin:1em 0 .5em 0">Modos de estudio:</h4>
  <ul>
    <li><strong>Modo Repaso</strong> (recomendado): Los ejercicios combinan gram√°tica del nivel actual y niveles anteriores para reforzar todo lo aprendido.</li>
    <li><strong>Modo Reforzar Nivel</strong>: Los ejercicios se centran exclusivamente en la gram√°tica del nivel actual para un estudio intensivo.</li>
  </ul>

  <div style="margin-top:1em;font-size:.97em;color:var(--accent)">¬°Explora, repite y aprende a tu ritmo!</div>
</div>

<script>
/* ---------- funci√≥n de log ---------- */
function logEvent(action, details='') {
  fetch('/.netlify/functions/log', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, details })
  }).catch(console.error);
}

/* ---------- configuraci√≥n ---------- */
const DICT_KEY='curso_sueco_diccionario';
const ENDPOINT='/.netlify/functions/openai';
const TTS_ENDPOINT='/.netlify/functions/tts';
  const LEVEL_KEY = 'curso_sueco_nivel';
  const THEME_KEY = 'curso_sueco_tema';

  // Temas disponibles: definen las variables CSS base
  const THEMES = {
    dark: { bg:'#121212', surface:'#1e1e1e', text:'#e0e0e0', primary:'#bb86fc', accent:'#03dac6' },
    red:  { bg:'#fff7f7', surface:'#ffffff', text:'#222222', primary:'#ff8a80', accent:'#ff5252' },
    green:{ bg:'#f7fff9', surface:'#ffffff', text:'#222222', primary:'#a5d6a7', accent:'#66bb6a' },
    blue: { bg:'#f7fbff', surface:'#ffffff', text:'#222222', primary:'#90caf9', accent:'#42a5f5' }
  };

  function applyTheme(themeName){
    const t = THEMES[themeName] || THEMES.dark;
    const root = document.documentElement;
    root.style.setProperty('--bg', t.bg);
    root.style.setProperty('--surface', t.surface);
    root.style.setProperty('--text', t.text);
    root.style.setProperty('--primary', t.primary);
    root.style.setProperty('--accent', t.accent);
    // Marcar activo en popover si existe
    const opts = document.querySelectorAll('#theme-popover .theme-option');
    opts.forEach(o=>{
      if(o.dataset.theme===themeName){ o.classList.add('theme-active'); }
      else { o.classList.remove('theme-active'); }
    });
    // Actualizar aria-expanded del bot√≥n
    const themeBtn = document.getElementById('theme-btn');
    if(themeBtn) themeBtn.setAttribute('aria-expanded', !document.getElementById('theme-popover').classList.contains('hidden'));
  }

  // Aplicar tema guardado al cargar
  (function(){
    const saved = localStorage.getItem(THEME_KEY) || 'dark';
    applyTheme(saved);
  })();

// === NUEVO: para modo autom√°tico ===
const SESSIONS_KEY = 'curso_sueco_sesiones';   // guardar√° cada lecci√≥n completa
let  allSessions   = JSON.parse(localStorage.getItem(SESSIONS_KEY) || '[]');

// Estado global de la lecci√≥n y diccionario
let dictionary = JSON.parse(localStorage.getItem(DICT_KEY) || '[]');
let currentLesson = null;

let nivel = Number(localStorage.getItem(LEVEL_KEY) || 1);
let modoEnfocado = localStorage.getItem('curso_sueco_modo_enfocado') === 'true';
const levels = [
  {id:1, nombre:'Nivel 1', descripcion:"Verbo 'vara' (ser/estar) y 'ha' (tener) en presente"},
  {id:2, nombre:'Nivel 2', descripcion:'Formaci√≥n b√°sica de oraciones afirmativas (orden S-V-O)'},
  {id:3, nombre:'Nivel 3', descripcion:'Art√≠culos definidos e indefinidos (en/ett, -en/-et, -n/-t)'},
  {id:4, nombre:'Nivel 4', descripcion:'Sustantivos en singular y plural (tipos de plural)'},
  {id:5, nombre:'Nivel 5', descripcion:'Adjetivos en forma b√°sica (atributiva) y concordancia'},
  {id:6, nombre:'Nivel 6', descripcion:"Negaci√≥n con 'inte' (posici√≥n en la frase)"},
  {id:7, nombre:'Nivel 7', descripcion:'Verbos regulares en presente y pasado (grupos verbales)'},
  {id:8, nombre:'Nivel 8', descripcion:'Pronombres posesivos (min, mitt, mina, etc.)'},
  {id:9, nombre:'Nivel 9', descripcion:'Preguntas con pronombres interrogativos (vad, vem, var, hur‚Ä¶)'} ,
  {id:10, nombre:'Nivel 10', descripcion:'Orden de palabras en preguntas y con adverbios iniciales (regla V2)'},
  {id:11, nombre:'Nivel 11', descripcion:"Adjetivos en forma predicativa (despu√©s de 'vara')"},
  {id:12, nombre:'Nivel 12', descripcion:'Preposiciones m√°s comunes (i, p√•, till, fr√•n, med, om‚Ä¶)'},
  {id:13, nombre:'Nivel 13', descripcion:'Verbos modales (kan, vill, m√•ste, f√•r, ska, b√∂r)'},
  {id:14, nombre:'Nivel 14', descripcion:'Comparativos y superlativos de adjetivos'},
  {id:15, nombre:'Nivel 15', descripcion:'Tiempos perfectos: perfekt y pluskvamperfekt (har gjort, hade gjort)'},
  {id:16, nombre:'Nivel 16', descripcion:'Pronombres objeto (mig, dig, honom, henne‚Ä¶)'},
  {id:17, nombre:'Nivel 17', descripcion:'Part√≠culas verbales y verbos separables (g√• ut, komma tillbaka)'},
  {id:18, nombre:'Nivel 18', descripcion:'Frases subordinadas (con att, om, n√§r, eftersom)'},
  {id:19, nombre:'Nivel 19', descripcion:"Voz pasiva (-s y 'bli')"},
  {id:20, nombre:'Nivel 20', descripcion:'Verbos reflexivos (kl√§ p√• sig, k√§nna sig)'},
  {id:21, nombre:'Nivel 21', descripcion:'Uso avanzado del orden V2 en oraciones largas'},
  {id:22, nombre:'Nivel 22', descripcion:'Pronombres relativos (som, vilken, vars)'},
  {id:23, nombre:'Nivel 23', descripcion:'Oraciones condicionales y subjuntivo moderno (skulle, om‚Ä¶)'},
  {id:24, nombre:'Nivel 24', descripcion:'Adverbios de frecuencia, modo y grado (ofta, g√§rna, mycket)'},
  {id:25, nombre:'Nivel 25', descripcion:"Construcciones impersonales y pasivas con 'man' y 'det'"}
];

// ===== NUEVO SISTEMA DE VOCABULARIO INTEGRADO =====

// Cache para el diccionario completo traducido
let diccionarioCompletoCache = null;

// Cache para frases de ejercicios
let frasesParaAppCache = null;

// Cache para ejemplos de vocabulario
let vocabularioCache = null;
let ejemplosUsados = {};

// Funci√≥n para cargar el diccionario completo traducido
async function cargarDiccionarioCompleto() {
  if (diccionarioCompletoCache) {
    return diccionarioCompletoCache;
  }
  
  try {
    const response = await fetch('data/diccionario_sueco_limpio.json');
    if (!response.ok) {
      throw new Error('Error cargando diccionario completo');
    }
    const data = await response.json();
    diccionarioCompletoCache = data;
    return diccionarioCompletoCache;
  } catch (error) {
    console.error('Error cargando diccionario completo:', error);
    return [];
  }
}

// Funci√≥n para cargar frases de ejercicios
async function cargarFrasesParaApp() {
  if (frasesParaAppCache) {
    return frasesParaAppCache;
  }
  
  try {
    const response = await fetch('data/frases_para_app.json');
    if (!response.ok) {
      throw new Error('Error cargando frases para app');
    }
    const data = await response.json();
    frasesParaAppCache = data;
    return frasesParaAppCache;
  } catch (error) {
    console.error('Error cargando frases para app:', error);
    return {};
  }
}

// Funci√≥n para cargar ejemplos de vocabulario
async function cargarEjemplosVocabulario() {
  if (vocabularioCache) {
    return vocabularioCache;
  }
  try {
    const response = await fetch('data/vocabulario_ejemplos.json');
    if (!response.ok) {
      throw new Error('Error cargando ejemplos de vocabulario');
    }
    const data = await response.json();
    vocabularioCache = data.ejemplos || {};
    return vocabularioCache;
  } catch (error) {
    console.error('Error cargando ejemplos de vocabulario:', error);
    return {};
  }
}

// Diccionario total (mantener para compatibilidad)
const totalDictionary = [
  'hate', 'create', 'hot', 'year', 'write', 'evening', 'hard', 'read', 'drink', 'big', 'slow', 'talk', 'banana', 'friend', 'remember', 'never', 'morning', 'place', 'love', 'work', 'car', 'listen', 'late', 'child', 'pen', 'mother', 'quickly', 'cold', 'good', 'walk', 'know', 'time', 'help', 'easily', 'father', 'week', 'cut', 'well', 'sometimes', 'ugly', 'break', 'old', 'forget', 'build', 'day', 'sell', 'think', 'often', 'new', 'slowly', 'weak', 'understand', 'like', 'run', 'teacher', 'city', 'badly', 'country', 'dog', 'sad', 'young', 'month', 'cat', 'night', 'beautiful', 'small', 'play', 'fast', 'book', 'student', 'house', 'table', 'apple', 'sleep', 'always', 'study', 'tree', 'buy', 'learn', 'close', 'name', 'clean', 'strong', 'cook', 'watch', 'early', 'open', 'drive', 'make', 'happy', 'chair', 'school', 'name', 'eat', 'bad', 'name', 'open', 'place', 'fast', 'hot', 'old', 'pen', 'cut', 'fast', 'teacher', 'walk', 'slowly', 'play', 'car', 'month', 'week', 'remember', 'sleep', 'talk', 'week', 'easily', 'strong', 'build', 'country', 'cook', 'father', 'listen', 'sometimes', 'talk', 'drive', 'week', 'big', 'sometimes', 'build', 'mother', 'badly', 'table', 'cook', 'drink', 'fast', 'clean', 'tree', 'weak', 'beautiful', 'forget', 'like', 'happy', 'slow', 'dog', 'pen', 'help', 'cut', 'month', 'weak', 'slowly', 'quickly', 'evening', 'like', 'quickly', 'sometimes', 'sell', 'late', 'understand', 'eat', 'run', 'work', 'young', 'read', 'play', 'car', 'work', 'place', 'drink', 'big', 'week', 'big', 'forget', 'build', 'apple', 'cook', 'time', 'break', 'strong', 'walk', 'night', 'talk', 'listen', 'sad', 'old', 'sad', 'day', 'week', 'night', 'run', 'sometimes', 'dog', 'buy', 'month', 'read', 'early', 'make', 'friend', 'easily', 'build', 'slowly', 'weak', 'father', 'dog', 'pen', 'country', 'teacher', 'school', 'small', 'bad', 'hate', 'drink', 'pen', 'hot', 'good', 'day', 'know', 'walk', 'badly', 'slowly', 'apple', 'school', 'apple', 'break', 'apple', 'place', 'watch', 'morning', 'badly', 'learn', 'learn', 'quickly', 'sell', 'student', 'country', 'clean', 'close', 'night', 'teacher', 'cook', 'study', 'dog', 'make', 'badly', 'cat', 'early', 'close', 'big', 'play', 'old', 'strong', 'day', 'learn', 'chair', 'teacher', 'late', 'drive', 'cut', 'well', 'clean', 'well', 'young', 'late', 'make', 'listen', 'child', 'young', 'car', 'watch', 'ugly', 'well', 'think', 'write', 'early', 'forget', 'small', 'fast', 'cook', 'talk', 'school', 'slowly', 'like', 'talk', 'apple', 'write', 'understand', 'car', 'know', 'remember', 'hard', 'evening', 'forget', 'dog', 'year', 'create', 'school', 'weak', 'clean', 'help', 'year', 'build', 'cut', 'break', 'day', 'ugly', 'always', 'table', 'never', 'table', 'week', 'school', 'easily', 'well', 'eat', 'forget', 'love', 'mother', 'love', 'weak', 'good', 'hot', 'slow', 'listen', 'cold', 'drink', 'apple', 'new', 'open', 'happy', 'banana', 'work', 'child', 'think', 'read', 'hate', 'school', 'tree', 'dog', 'hard', 'evening', 'weak', 'work', 'buy', 'sleep', 'close', 'make', 'love', 'pen', 'open', 'father', 'badly', 'child', 'book', 'ugly', 'big', 'talk', 'fast', 'city', 'bad', 'think', 'sell', 'think', 'week', 'small', 'watch', 'buy', 'young', 'house', 'evening', 'dog', 'sleep', 'break', 'car', 'school', 'run', 'quickly', 'hot', 'cold', 'drive', 'friend', 'open', 'early', 'break', 'bad', 'morning', 'strong', 'break', 'often', 'always', 'house', 'new', 'sad', 'day', 'sad', 'talk', 'father', 'watch', 'small', 'love', 'month', 'banana', 'buy', 'remember', 'remember', 'tree', 'country', 'remember', 'easily', 'young', 'easily', 'sometimes', 'always', 'clean', 'beautiful', 'cold', 'day', 'close', 'make', 'run', 'new', 'clean', 'sell', 'talk', 'city', 'bad', 'watch', 'read', 'father', 'never', 'small', 'hard', 'mother', 'help', 'car', 'small', 'city', 'always', 'often', 'weak', 'happy', 'late', 'know', 'city', 'time', 'love', 'create', 'remember', 'sell', 'day', 'young', 'clean', 'listen', 'close', 'watch', 'always'
];

// Funci√≥n para obtener ejemplos negativos (niveles fuera del rango de estudio)
function getEjemplosNegativos(nivelActual) {
  const nivelesFuera = [];
  const nivelesEnEstudio = modoEnfocado ? [nivelActual] : [nivelActual, nivelActual-1, nivelActual-2];
  
  for (let i = 1; i <= 25; i++) {
    if (!nivelesEnEstudio.includes(i) && ejemplosPorNivel[i]) {
      nivelesFuera.push({
        nivel: i,
        descripcion: levels[i-1].descripcion,
        ejemplo: ejemplosPorNivel[i].valid[0]
      });
    }
  }
  
  // Tomar solo los primeros 5 ejemplos negativos para no hacer el prompt muy largo
  return nivelesFuera.slice(0, 5);
}

// Funci√≥n para generar distribuci√≥n espec√≠fica de ejercicios
function getDistribucionEjercicios(nivelActual) {
  if (modoEnfocado) {
    return `Distribuci√≥n: 10 frases del nivel actual (${levels[nivelActual-1].descripcion})`;
  } else {
    const nivel1 = nivelActual;
    const nivel2 = Math.max(1, nivelActual - 1);
    const nivel3 = Math.max(1, nivelActual - 2);
    const nivel4 = Math.max(1, nivelActual - 3);
    
    return `Distribuci√≥n:
- 4 frases del nivel actual (${levels[nivel1-1].descripcion})
- 3 frases del nivel anterior (${levels[nivel2-1].descripcion})
- 2 frases del nivel -2 (${levels[nivel3-1].descripcion})
- 1 frase del nivel -3 (${levels[nivel4-1].descripcion})`;
  }
}

function getGrammarInstructions(nivel) {
  let out = '‚Äì Frases simples.';
  for (let i = 0; i < nivel; ++i) {
    let desc = levels[i].descripcion;
    if (i === 2) desc = desc.replace('afirm./neg.', 'afirmativo y negativo');
    out += `\n  ‚Äì ${desc}`;
  }
  return out;
}
async function askOpenAI(prompt){
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout
  
  try {
    const r = await fetch(ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({prompt}),
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    if(!r.ok) throw new Error(r.statusText);
    return (await r.json()).content.trim();
  } catch (e) {
    clearTimeout(timeoutId);
    if (e.name === 'AbortError') {
      throw new Error('Timeout: La respuesta tard√≥ m√°s de 30 segundos');
    }
    throw e;
  }
}

/* ---------- TTS ---------- */
const audioCache=new Map();
async function speak(el,txt){
  if(audioCache.has(txt)){new Audio(audioCache.get(txt)).play();return;}
  el.textContent='‚è≥';
  try{
    const r=await fetch(TTS_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:txt})});
    if(!r.ok)throw new Error('TTS error');
    const b64=(await r.json()).audio;
    const blob=await fetch(`data:audio/mp3;base64,${b64}`).then(r=>r.blob());
    const url=URL.createObjectURL(blob);
    audioCache.set(txt,url);el.textContent='üîä';new Audio(url).play();
    logEvent('tts', txt);              /* ‚Üê LOG AUDIO */
  }catch(e){el.textContent='‚ùå';console.error(e);}
}
const speakIcon=t=>` <span class="speak" data-text="${t}">üîä</span>`;

/* ---------- Estado UI (status) ---------- */
let statusTimer = null;
function setStatus(text){
  const el = document.getElementById('status');
  if (el) el.textContent = text;
}
function setStatusWithTimer(text, debugInfo = ''){
  const el = document.getElementById('status');
  const dbg = document.getElementById('debug-status');
  if (dbg) dbg.textContent = debugInfo || '';
  if (statusTimer) { clearInterval(statusTimer); statusTimer = null; }
  if (el) el.textContent = text;
  let dots = 0;
  statusTimer = setInterval(()=>{
    dots = (dots + 1) % 4;
    const msg = text + '.'.repeat(dots);
    if (el) el.textContent = msg;
  }, 500);
}

/* ---------- generaci√≥n de datos ---------- */
async function fetchNewWords(isDebugMode = false, debugInfo = ''){
  setStatusWithTimer('üîé Seleccionando palabras‚Ä¶', debugInfo);
  
  // Cargar diccionario completo traducido
  const diccionarioCompleto = await cargarDiccionarioCompleto();
  
  // Obtener palabras ya usadas del diccionario local
  const usedWords = new Set(dictionary.map(w => (w.sv||'').toLowerCase()));
  
  // Filtrar palabras disponibles del diccionario traducido
  const availableWords = diccionarioCompleto.filter(word => 
    !usedWords.has((word.sv||'').toLowerCase())
  );
  
  // Si no hay suficientes palabras disponibles, resetear el diccionario local
  if (availableWords.length < 10) {
    console.warn('Pocas palabras disponibles, reseteando diccionario local');
    dictionary = [];
    localStorage.setItem(DICT_KEY, JSON.stringify(dictionary));
    return fetchNewWords(isDebugMode, debugInfo); // Llamada recursiva
  }
  
  // Seleccionar 10 palabras aleatorias
  const selectedWords = [];
  const shuffled = [...availableWords].sort(() => Math.random() - 0.5);
  
  for (let i = 0; i < 10 && i < shuffled.length; i++) {
    selectedWords.push(shuffled[i]);
  }
  
  // Cargar ejemplos de vocabulario si no est√°n cargados
  if (!vocabularioCache) {
    await cargarEjemplosVocabulario();
  }
  
  // Crear vocabulario con ejemplos mejorados
  const vocabulario = selectedWords.map(word => {
    const ejemplo = obtenerEjemploVocabulario(word.sv);
    return {
      sv: word.sv,
      es: word.es,
      ej_sv: ejemplo.ej_sv || ejemplo.ej_en || `Exempel med ${word.sv}`,
      ej_es: ejemplo.ej_es
    };
  });
  
  return vocabulario;
}

// ===== SISTEMA DE FRASES LOCALES =====

// Cache para frases cargadas
let frasesCache = {};

// Funci√≥n para cargar frases de un nivel espec√≠fico
async function cargarFrasesNivel(nivelId) {
  if (frasesCache[nivelId]) {
    return frasesCache[nivelId];
  }
  
  try {
    const response = await fetch(`data/nivel_${nivelId}_depurado.json`);
    if (!response.ok) {
      throw new Error(`Error cargando frases del nivel ${nivelId}`);
    }
    const data = await response.json();
    frasesCache[nivelId] = data.frases || [];
    return frasesCache[nivelId];
  } catch (error) {
    console.error(`Error cargando frases del nivel ${nivelId}:`, error);
    return [];
  }
}

// Funci√≥n para obtener frases no usadas de un nivel
function obtenerFrasesNoUsadas(nivelId, frases) {
  const frasesUsadas = JSON.parse(localStorage.getItem(`frases_usadas_nivel_${nivelId}`) || '[]');
  const frasesDisponibles = frases.filter(frase => !frasesUsadas.includes(frase.id));
  
  // Si no hay frases disponibles, resetear el nivel
  if (frasesDisponibles.length === 0) {
    localStorage.removeItem(`frases_usadas_nivel_${nivelId}`);
    return frases; // Devolver todas las frases
  }
  
  return frasesDisponibles;
}

// Funci√≥n para marcar frase como usada
function marcarFraseUsada(nivelId, fraseId) {
  const frasesUsadas = JSON.parse(localStorage.getItem(`frases_usadas_nivel_${nivelId}`) || '[]');
  if (!frasesUsadas.includes(fraseId)) {
    frasesUsadas.push(fraseId);
    localStorage.setItem(`frases_usadas_nivel_${nivelId}`, JSON.stringify(frasesUsadas));
  }
}

// Funci√≥n para seleccionar frases aleatorias
function seleccionarFrasesAleatorias(frases, cantidad) {
  const frasesAleatorias = [];
  const frasesTemp = [...frases];
  
  for (let i = 0; i < cantidad && frasesTemp.length > 0; i++) {
    const indiceAleatorio = Math.floor(Math.random() * frasesTemp.length);
    frasesAleatorias.push(frasesTemp[indiceAleatorio]);
    frasesTemp.splice(indiceAleatorio, 1);
  }
  
  return frasesAleatorias;
}

// ===== SISTEMA DE EJEMPLOS DE VOCABULARIO =====

// Funci√≥n para obtener ejemplo de vocabulario no usado
function obtenerEjemploVocabulario(palabra) {
  // Buscar en el cach√© de vocabulario por la palabra en sueco (sv)
  const palabraNormalizada = palabra.toLowerCase();
  const ejemplosVocab = vocabularioCache ? vocabularioCache[palabraNormalizada] : undefined;

  if (!ejemplosVocab || !ejemplosVocab.ejemplos || ejemplosVocab.ejemplos.length === 0) {
    // Fallback si no se encuentran ejemplos para la palabra
    return {
      ej_sv: `Exempel med ${palabra}`,
      ej_es: `Ejemplo con ${palabra} üòä`
    };
  }
  
  // Obtener ejemplos usados para esta palabra
  const usados = JSON.parse(localStorage.getItem(`vocab_usado_${palabra}`) || '[]');
  const ejemplosDisponibles = ejemplosVocab.ejemplos.filter((_, index) => !usados.includes(index));
  
  // Si no hay ejemplos disponibles, resetear
  if (ejemplosDisponibles.length === 0) {
    localStorage.removeItem(`vocab_usado_${palabra}`);
    return ejemplosVocab.ejemplos[Math.floor(Math.random() * ejemplosVocab.ejemplos.length)];
  }
  
  // Seleccionar ejemplo aleatorio disponible
  const indiceAleatorio = Math.floor(Math.random() * ejemplosDisponibles.length);
  const ejemploSeleccionado = ejemplosDisponibles[indiceAleatorio];
  
  // Marcar como usado
  const indiceOriginal = ejemplosVocab.ejemplos.indexOf(ejemploSeleccionado);
  usados.push(indiceOriginal);
  localStorage.setItem(`vocab_usado_${palabra}`, JSON.stringify(usados));
  
  return ejemploSeleccionado;
}

async function fetchLesson(words, isDebugMode = false, debugInfo = ''){
  setStatusWithTimer('üõ†Ô∏è Cargando ejercicios‚Ä¶', debugInfo);
  
  // Generar explicaci√≥n gramatical (con manejo de errores)
  let grammarExplanation = '';
  try {
    const grammarExplanationPrompt = `Explica brevemente (1-2 l√≠neas) la gram√°tica del nivel ${nivel}: "${levels[nivel-1].descripcion}" para un estudiante de 10-11 a√±os.`;
    grammarExplanation = await askOpenAI(grammarExplanationPrompt);
  } catch (e) {
    console.error('Error generando explicaci√≥n gramatical:', e);
    grammarExplanation = `Gram√°tica del nivel ${nivel}: ${levels[nivel-1].descripcion}`;
  }

  // Cargar frases de ejercicios seg√∫n el modo
  let ejercicios = [];
  
  try {
    const frasesParaApp = await cargarFrasesParaApp();
    
    if (modoEnfocado || nivel === 1) {
      // MODO REFORZAR O NIVEL 1: Solo frases del nivel actual (10 ejercicios)
      const frasesNivelActual = frasesParaApp[nivel.toString()]?.frases || [];
      ejercicios = seleccionarFrasesAleatorias(frasesNivelActual, 10);
      
    } else {
      // MODO REPASO (niveles 2+): 5 del nivel actual + 5 de niveles inferiores
      const frasesNivelActual = frasesParaApp[nivel.toString()]?.frases || [];
      const frasesNivelActualSeleccionadas = seleccionarFrasesAleatorias(frasesNivelActual, 5);
      
      // Obtener frases de niveles inferiores
      const frasesNivelesInferiores = [];
      for (let nivelInferior = 1; nivelInferior < nivel; nivelInferior++) {
        const frasesNivel = frasesParaApp[nivelInferior.toString()]?.frases || [];
        frasesNivelesInferiores.push(...frasesNivel);
      }
      
      const frasesNivelesInferioresSeleccionadas = seleccionarFrasesAleatorias(frasesNivelesInferiores, 5);
      ejercicios = [...frasesNivelActualSeleccionadas, ...frasesNivelesInferioresSeleccionadas];
    }
    
  } catch (error) {
    console.error('Error cargando frases de ejercicios:', error);
    // Fallback al sistema anterior
    if (modoEnfocado || nivel === 1) {
      const frasesNivelActual = await cargarFrasesNivel(nivel);
      const frasesDisponibles = obtenerFrasesNoUsadas(nivel, frasesNivelActual);
      ejercicios = seleccionarFrasesAleatorias(frasesDisponibles, 10);
      ejercicios.forEach(frase => marcarFraseUsada(nivel, frase.id));
    } else {
      const frasesNivelActual = await cargarFrasesNivel(nivel);
      const frasesDisponiblesActual = obtenerFrasesNoUsadas(nivel, frasesNivelActual);
      const frasesNivelActualSeleccionadas = seleccionarFrasesAleatorias(frasesDisponiblesActual, 5);
      frasesNivelActualSeleccionadas.forEach(frase => marcarFraseUsada(nivel, frase.id));
      
      const frasesNivelesInferiores = [];
      for (let nivelInferior = 1; nivelInferior < nivel; nivelInferior++) {
        const frasesNivel = await cargarFrasesNivel(nivelInferior);
        const frasesDisponibles = obtenerFrasesNoUsadas(nivelInferior, frasesNivel);
        frasesNivelesInferiores.push(...frasesDisponibles);
      }
      
      const frasesNivelesInferioresSeleccionadas = seleccionarFrasesAleatorias(frasesNivelesInferiores, 5);
      frasesNivelesInferioresSeleccionadas.forEach(frase => {
        const nivelFrase = parseInt(frase.id.split('_')[0].substring(1));
        marcarFraseUsada(nivelFrase, frase.id);
      });
      
      ejercicios = [...frasesNivelActualSeleccionadas, ...frasesNivelesInferioresSeleccionadas];
    }
  }
  
  // Convertir frases al formato esperado
  const ejerciciosFormateados = ejercicios.map(frase => ({
    es: frase.es,
    sv: frase.sv || frase.en
  }));
  
  return {
    vocabulario: words, // words ya vienen con ejemplos desde fetchNewWords
    ejercicios: ejerciciosFormateados,
    grammarExplanation
  };
}


/* ---------- render ---------- */
// Referencias a los contenedores principales
const vocabEl = document.getElementById('vocab-list');
const exEl    = document.getElementById('exercise-list');
const repEl   = document.getElementById('review-list');

function renderLesson(les){
  vocabEl.innerHTML=exEl.innerHTML=repEl.innerHTML='';
  
  // Mostrar explicaci√≥n gramatical
  const grammarEl = document.getElementById('grammar-explanation');
  if (grammarEl && les.grammarExplanation) {
    grammarEl.innerHTML = `<strong>üìö Gram√°tica del nivel ${nivel}: ${levels[nivel-1].descripcion}</strong><br>${les.grammarExplanation}`;
  }
  les.vocabulario.forEach(w=>{
    vocabEl.insertAdjacentHTML('beforeend',
      `<div class="item"><strong>${w.es}</strong> ‚Äì ${w.sv}${speakIcon(w.sv)}<br>
       <span class="example">${decodeEmojis(w.ej_es)}<br>
       <strong>${stripEmojis(w.ej_sv||w.ej_en)}</strong>${speakIcon(w.ej_sv||w.ej_en)}</span></div>`);
  });
  les.ejercicios.forEach((f,i)=>{
    exEl.insertAdjacentHTML('beforeend',
      `<div class="item">${i+1}. ${decodeEmojis(f.es)}
         <button class="show">Soluci√≥n</button>
         <span class="hidden">${stripEmojis(f.sv)}${speakIcon(f.sv)}</span></div>`);
  });
  les.repaso.forEach(p=>{
    const esTxt=p.es??p.espanol??(Array.isArray(p)?p[0]:Object.values(p)[0]);
    const svTxt=p.sv??p.sueco ??(Array.isArray(p)?p[1]:Object.values(p)[1]??'');
    repEl.insertAdjacentHTML('beforeend',
      `<div class="item">${decodeEmojis(esTxt)}
         <button class="show">Soluci√≥n</button>
         <span class="hidden">${decodeEmojis(svTxt)}${speakIcon(svTxt)}</span></div>`);
  });
  currentLesson=les;
}

/* ---------- eventos ---------- */
document.addEventListener('click',e=>{
  if(e.target.classList.contains('speak')) speak(e.target,e.target.dataset.text);
  if(e.target.classList.contains('show')){
    e.target.nextElementSibling.classList.toggle('hidden');
    logEvent('click_boton', 'Mostrar soluci√≥n');
  }
    // Cerrar popover de tema si se hace click fuera
    const pop = document.getElementById('theme-popover');
    const btn = document.getElementById('theme-btn');
    if(pop && !pop.classList.contains('hidden')){
      const clickedInside = pop.contains(e.target) || btn.contains(e.target);
      if(!clickedInside){ pop.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }
    }
});

/* ---------- flujo principal ---------- */
async function generate(isDebugMode = false){
  try {
    const debugInfo = window.isDebugMode ? `Nivel ${window.debugLevel || nivel}` : '';
    
    // Cargar datos necesarios al inicio
    setStatusWithTimer('üìö Cargando sistema de vocabulario‚Ä¶', debugInfo);
    await Promise.all([
      cargarDiccionarioCompleto(),
      cargarFrasesParaApp(),
      cargarEjemplosVocabulario()
    ]);
    
    const words = await fetchNewWords(window.isDebugMode, debugInfo);
    const lesson = await fetchLesson(words, window.isDebugMode, debugInfo);

    // ‚ñ∫ elegimos 10 palabras antiguas para el repaso
    const extra = dictionary
                   .filter(d => !words.some(w => w.sv === d.sv))
                   .sort(() => Math.random() - 0.5)
                   .slice(0, 10)
                   .map(d => ({es: d.es, sv: d.sv}));

    lesson.repaso = [
      ...words.map(w => ({es: w.es, sv: w.sv})),
      ...extra
    ];

    renderLesson(lesson);
    // Limpiar timer y mostrar mensaje final
    if (statusTimer) {
      clearInterval(statusTimer);
      statusTimer = null;
    }
    setStatus('‚úÖ Lecci√≥n lista (Nivel ' + nivel + ': ' + levels[nivel-1].descripcion + ')');
    logEvent('iniciar_leccion_auto', `Nivel ${nivel}`);

    return lesson;          // ‚Üê ahora la funci√≥n DEVUELVE la lecci√≥n
  } catch (e) {
    console.error(e);
    if (window.isDebugMode) {
      // En modo depuraci√≥n, no recargar la p√°gina, solo mostrar error
      setStatus('‚ùå Error en generaci√≥n - Continuando...');
      throw e;
    } else {
      setStatus('Cargando p√°gina‚Ä¶');
      setTimeout(() => location.reload(), 2000);
      throw e;
    }
  }
}
/* ---------- TERMINAR LECCI√ìN (funci√≥n nueva) ---------- */
function terminarLeccion(lesson){
  // 1¬∑ A√±ade el vocabulario nuevo al diccionario
  let newWordsCount = 0;
  lesson.vocabulario.forEach(w=>{
    if(!dictionary.some(d => d.sv === w.sv)){
      dictionary.push({sv: w.sv, es: w.es});
      newWordsCount++;
    }
  });
  localStorage.setItem(DICT_KEY, JSON.stringify(dictionary));

  // 2¬∑ Guarda la lecci√≥n completa en el hist√≥rico
  allSessions.push({...lesson, nivel, timestamp: Date.now()});
  localStorage.setItem(SESSIONS_KEY, JSON.stringify(allSessions));

  // 3¬∑ Registro en el log
  logEvent('terminar_leccion_auto', `Nivel ${nivel}, total sesiones: ${allSessions.length}, palabras nuevas: ${newWordsCount}, total diccionario: ${dictionary.length}`);

  // 4¬∑ Comprobar si el diccionario est√° completo y vaciarlo
  checkAndClearDictionary();

  // 5¬∑ Log adicional para debug
  if (window.isDebugMode) {
    console.log(`DEBUG: Terminada lecci√≥n - Nivel ${nivel}, palabras nuevas: ${newWordsCount}, total diccionario: ${dictionary.length}`);
  }
}

/* ---------- NUEVA FUNCI√ìN: Comprobar y vaciar diccionario ---------- */
async function checkAndClearDictionary() {
  try {
    const totalDict = await cargarDiccionarioCompleto();
    if (dictionary.length >= totalDict.length) {
      console.log('Diccionario local completo. Vaciando...');
      logEvent('diccionario_completo', `Se vaci√≥ el diccionario con ${dictionary.length} palabras.`);
      dictionary = [];
      localStorage.setItem(DICT_KEY, JSON.stringify(dictionary));
    }
  } catch (error) {
    console.error('Error al comprobar el diccionario completo:', error);
  }
}



window.addEventListener('load',()=>{
  // Re-obtener referencias cr√≠ticas para aislar problemas de inicializaci√≥n
  const levelRadioList = document.getElementById('level-radio-list');
  const levelCurrent = document.getElementById('level-current');
  const levelCurrentBtn = document.getElementById('level-current-btn');
  const levelNextBtn = document.getElementById('level-next-btn');
  const levelToggleSelect = document.getElementById('level-toggle-select');
  const levelSelectWrap = document.getElementById('level-select-wrap');
  const levelSaveBtn = document.getElementById('level-save-btn');
  const btnShow = document.getElementById('show-dict');
  const btnClear = document.getElementById('clear-dict');
  const dictBox = document.getElementById('dict-box');
  const toggleAbout = document.getElementById('toggle-about');
  const aboutText = document.getElementById('about-text');
  // --- Inicializar selector de nivel ---
  if (levelRadioList && levelCurrent) {
    levelCurrent.textContent = `${nivel}. ${levels[nivel-1].descripcion}`;
    // Crear radio buttons para selecci√≥n m√∫ltiple
    levelRadioList.innerHTML = levels.map(l => `
      <div style="margin-bottom:.5rem">
        <input type="radio" id="level-${l.id}" name="level-select" value="${l.id}" ${l.id === nivel ? 'checked' : ''}>
        <label for="level-${l.id}" style="margin-left:.5rem">${l.id}. ${l.nombre} ‚Äî ${l.descripcion}</label>
      </div>
    `).join('');
    // Bot√≥n avanzar nivel
    levelNextBtn.onclick = function() {
      if (nivel < levels.length) {
        nivel++;
        localStorage.setItem(LEVEL_KEY, nivel);
        levelCurrent.textContent = `${nivel}. ${levels[nivel-1].descripcion}`;
        document.querySelectorAll('input[name="level-select"]').forEach(radio => {
          radio.checked = radio.value == nivel;
        });
        // Guardar vocabulario y recargar como si se hubiera terminado la lecci√≥n
        if(currentLesson) {
          currentLesson.vocabulario.forEach(w=>{
            if(!dictionary.some(d=>d.sv===w.sv)) dictionary.push({sv:w.sv,es:w.es});
          });
          localStorage.setItem(DICT_KEY,JSON.stringify(dictionary));
        }
        logEvent('nivel_avanzar', `Nuevo nivel: ${nivel}`);
        logEvent('terminar_leccion', `Palabras nuevas: ${currentLesson?.vocabulario?.length||0}`);
        document.querySelectorAll('.item span:not(.hidden)').forEach(el=>el.classList.add('hidden'));
        dictBox.classList.add('hidden'); btnClear.classList.add('hidden'); btnShow.textContent='Ver diccionario completo';
        aboutText.classList.add('hidden'); toggleAbout.textContent='‚ñ∏ Sobre la aplicaci√≥n';
        window.scrollTo({top:0,left:0,behavior:'smooth'});
        setTimeout(()=>location.reload(),500);
      }
    };
    // Bot√≥n mostrar selector
    levelToggleSelect.onclick = function() {
      levelSelectWrap.classList.toggle('hidden');
      if (!levelSelectWrap.classList.contains('hidden')) {
        levelSelectWrap.style.display = 'block';
        logEvent('nivel_selector_abrir', 'Abre selector de nivel');
      } else {
        levelSelectWrap.style.display = '';
      }
    };
    // Bot√≥n guardar selecci√≥n (Guardar y terminar lecci√≥n en selector)
    levelSaveBtn.onclick = function() {
      const selectedRadio = document.querySelector('input[name="level-select"]:checked');
      if (selectedRadio) {
        nivel = Number(selectedRadio.value);
        localStorage.setItem(LEVEL_KEY, nivel);
        levelCurrent.textContent = `${nivel}. ${levels[nivel-1].descripcion}`;
        levelSelectWrap.classList.add('hidden');
        // Guardar vocabulario y recargar como si se hubiera terminado la lecci√≥n
        if(currentLesson) {
          currentLesson.vocabulario.forEach(w=>{
            if(!dictionary.some(d=>d.sv===w.sv)) dictionary.push({sv:w.sv,es:w.es});
          });
          localStorage.setItem(DICT_KEY,JSON.stringify(dictionary));
        }
        logEvent('nivel_guardar', `Nivel guardado: ${nivel}`);
        logEvent('terminar_leccion', `Palabras nuevas: ${currentLesson?.vocabulario?.length||0}`);
        document.querySelectorAll('.item span:not(.hidden)').forEach(el=>el.classList.add('hidden'));
        dictBox.classList.add('hidden'); btnClear.classList.add('hidden'); btnShow.textContent='Ver diccionario completo';
        aboutText.classList.add('hidden'); toggleAbout.textContent='‚ñ∏ Sobre la aplicaci√≥n';
        window.scrollTo({top:0,left:0,behavior:'smooth'});
        setTimeout(()=>location.reload(),500);
      }
    };
    // Al hacer click en el bot√≥n de nivel actual, tambi√©n muestra el selector
    levelCurrentBtn.onclick = function() {
      levelSelectWrap.classList.toggle('hidden');
      if (!levelSelectWrap.classList.contains('hidden')) {
        levelSelectWrap.style.display = 'block';
        logEvent('nivel_selector_abrir', 'Abre selector de nivel desde bot√≥n nivel actual');
      } else {
        levelSelectWrap.style.display = '';
      }
    };
    // Log para selecci√≥n de radio
    levelRadioList.addEventListener('change', function(e) {
      if(e.target && e.target.matches('input[type="radio"]')) {
        logEvent('nivel_radio_seleccion', `Seleccionado: ${e.target.value}`);
      }
    });
    
    // Funcionalidad de los botones de modo
    const modeRepaso = document.getElementById('mode-repaso');
    const modeReforzar = document.getElementById('mode-reforzar');
    
    if (modeRepaso && modeReforzar) {
      // Actualizar estado inicial de los botones
      updateModeButtons();
      
      modeRepaso.addEventListener('click', function() {
        modoEnfocado = false;
        localStorage.setItem('curso_sueco_modo_enfocado', 'false');
        updateModeButtons();
        logEvent('modo_cambio', 'Modo Repaso');
      });
      
      modeReforzar.addEventListener('click', function() {
        modoEnfocado = true;
        localStorage.setItem('curso_sueco_modo_enfocado', 'true');
        updateModeButtons();
        logEvent('modo_cambio', 'Modo Reforzar Nivel');
      });
    }
    
    function updateModeButtons() {
      if (modeRepaso && modeReforzar) {
        if (modoEnfocado) {
          // Modo Reforzar activo
          modeReforzar.style.background = '#90EE90';
          modeReforzar.style.color = '#333';
          modeReforzar.style.border = 'none';
          modeReforzar.style.fontWeight = 'bold';
          
          modeRepaso.style.background = '#4a4a4a';
          modeRepaso.style.color = '#ccc';
          modeRepaso.style.border = '1px solid var(--primary)';
          modeRepaso.style.fontWeight = 'normal';
        } else {
          // Modo Repaso activo
          modeRepaso.style.background = '#90EE90';
          modeRepaso.style.color = '#333';
          modeRepaso.style.border = 'none';
          modeRepaso.style.fontWeight = 'bold';
          
          modeReforzar.style.background = '#4a4a4a';
          modeReforzar.style.color = '#ccc';
          modeReforzar.style.border = '1px solid var(--primary)';
          modeReforzar.style.fontWeight = 'normal';
        }
      }
    }
  }
  navigator.onLine?generate():setStatus('Sin conexi√≥n');
});

/* ---------- bot√≥n FIN ---------- */
document.getElementById('finish-btn').addEventListener('click', ()=>{
  if (!currentLesson) return;          // si a√∫n no hay lecci√≥n, salir
  terminarLeccion(currentLesson);      // usa la funci√≥n nueva
  window.scrollTo({top:0,left:0,behavior:'smooth'});
  setTimeout(()=>location.reload(), 500);
});

/* ---------- CHAT ---------- */
document.getElementById('chat-send').onclick=sendChat;
const _chatInp = document.getElementById('chat-input');
if (_chatInp) _chatInp.addEventListener('keypress',e=>{if(e.key==='Enter')sendChat();});
async function sendChat(){
  const chatBox = document.getElementById('chat-box');
  const q=_chatInp.value.trim(); if(!q) return; _chatInp.value='';
  chatBox.insertAdjacentHTML('beforeend',`<div><strong>T√∫:</strong> ${q}</div>`); chatBox.scrollTop=chatBox.scrollHeight;
  logEvent('chat_usuario', q);
  try{
    const a=await askOpenAI(
      `Act√∫a como profesor de sueco (ni√±os 10-11 a√±os). Responde en espa√±ol con tono natural y breve (3‚Äì5 frases). ` +
      `No uses Markdown (sin **negritas** ni *cursivas*). Usa saltos de l√≠nea para separar ideas y p√°rrafos. ` +
      `Incluye 1‚Äì2 ejemplos en sueco integrados en el texto. ` +
      `Si la pregunta no trata sobre aprender sueco, la lengua sueca o temas propios de una clase de sueco, responde amablemente: "Lo siento, esto no lo podemos tratar en una clase de sueco" y no entres en el tema. ` +
      `Pregunta del alumno: ${q}`
    );
    // Formatear salida: limpiar Markdown y forzar saltos de l√≠nea si no vienen
    const formatted = formatAssistantText(a);
    chatBox.insertAdjacentHTML('beforeend',`<div><strong>Profesor:</strong> ${formatted}</div>`); chatBox.scrollTop=chatBox.scrollHeight;
  }catch(e){chatBox.insertAdjacentHTML('beforeend',`<div style="color:#ff6b6b;">Error: ${e.message}</div>`);}
}

/* ---------- Diccionario completo ---------- */
(function initDictUI(){
  const _btnShow = document.getElementById('show-dict');
  const _btnClear = document.getElementById('clear-dict');
  const _dictBox = document.getElementById('dict-box');
  if(_btnShow){
    _btnShow.addEventListener('click',()=>{
      if(_dictBox.classList.contains('hidden')){
        const list=JSON.parse(localStorage.getItem(DICT_KEY)||'[]');
        _dictBox.textContent=list.length?list.map((w,i)=>`${i+1}. ${w.es} ‚Äì ${w.sv}`).join('\n'):'(diccionario vac√≠o)';
        _dictBox.classList.remove('hidden'); if(_btnClear) _btnClear.classList.remove('hidden'); _btnShow.textContent='Ocultar diccionario';
        logEvent('click_boton','Mostrar diccionario');
      }else{
        _dictBox.classList.add('hidden'); if(_btnClear) _btnClear.classList.add('hidden'); _btnShow.textContent='Ver diccionario completo';
        logEvent('click_boton','Ocultar diccionario');
      }
    });
  }
  if(_btnClear){
    _btnClear.addEventListener('click',()=>{
      if(confirm('¬øBorrar todo el diccionario guardado?')){
        localStorage.removeItem(DICT_KEY); dictionary=[]; _dictBox.textContent='(diccionario borrado)';
        logEvent('click_boton','Borrar diccionario');
      }
    });
  }
})();

/* ---------- Sobre la aplicaci√≥n ---------- */
(function initAbout(){
  const _toggleAbout = document.getElementById('toggle-about');
  const _aboutText = document.getElementById('about-text');
  if(_toggleAbout && _aboutText){
    _toggleAbout.addEventListener('click',()=>{
      const open=!_aboutText.classList.toggle('hidden');
      _toggleAbout.textContent=(open?'‚ñæ':'‚ñ∏')+' Sobre la aplicaci√≥n';
      logEvent('click_boton', open?'Mostrar sobre':'Ocultar sobre');
    });
  }
})();

function enviarSugerencia() {
  const comentario = document.getElementById('sugerencia').value;
  const mensaje = document.getElementById('mensaje-enviado');
  if (!comentario.trim()) return;

  fetch('/.netlify/functions/log', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      ip: 'auto', // o '127.0.0.1' si prefieres
      action: 'sugerencia',
      details: comentario,
      key: 'TU_CLAVE'
    })
  }).then(res => res.json())
    .then(() => {
      mensaje.style.display = 'block';
      document.getElementById('sugerencia').value = '';
      setTimeout(() => mensaje.style.display = 'none', 3000);
    }).catch(console.error);
}

// Ayuda flotante
function openHelpModal(e) {
  e.preventDefault();
  e.stopPropagation();
  var helpModal = document.getElementById('help-modal');
  if(helpModal) helpModal.classList.add('visible');
}
const helpModal = document.getElementById('help-modal');
if(helpModal) {
  helpModal.querySelector('.close-help').onclick = function(e) {
    e.preventDefault();
    e.stopPropagation();
    helpModal.classList.remove('visible');
  };
  // Cerrar con Escape
  document.addEventListener('keydown', function(e) {
    if(helpModal.classList.contains('visible') && e.key === 'Escape') helpModal.classList.remove('visible');
  });

  // --- Tema: listeners ---
  (function initThemeUI(){
    const btn = document.getElementById('theme-btn');
    const pop = document.getElementById('theme-popover');
    if(!btn || !pop) return;
    btn.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      const isHidden = pop.classList.contains('hidden');
      pop.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!isHidden));
    });
    pop.addEventListener('click', function(e){
      const opt = e.target.closest('.theme-option');
      if(!opt) return;
      const themeName = opt.dataset.theme;
      localStorage.setItem(THEME_KEY, themeName);
      applyTheme(themeName);
      pop.classList.add('hidden');
      btn.setAttribute('aria-expanded', 'false');
      logEvent('tema_cambiado', themeName);
    });
  })();
}
// ---------- Utilidad: formatear texto del asistente con saltos de l√≠nea ----------
function formatAssistantText(text){
  let out = String(text || '');
  // limpiar markdown simple
  out = out.replace(/\*\*+/g,'').replace(/\*/g,'');
  out = out.replace(/^\s*[-‚Ä¢]\s*/gm,'');
  // si no hay \n, insertar cortes suaves tras punto seguido cuando va seguido de may√∫scula
  if(!/\n/.test(out)){
    out = out.replace(/\.\s+(?=[A-Z√Å√â√ç√ì√ö√ë])/g, '.\n');
  }
  // convertir \n a <br>
  out = out.replace(/\n/g,'<br>');
  return out;
}
/* ---------- EXPORTAR CSV ---------- */
function exportAsCSV(data){
  const rows = [];
  // cabecera
  rows.push(['nivel','sesion','ejemplo_sv'].join(','));

  data.forEach((les,i)=>{
    const sesionesPorNivel = window.debugConfig?.sesiones || 1;
    const sesion = (i % sesionesPorNivel) + 1; // 1-X dentro del nivel
    les.vocabulario.forEach(vocab=>{
      rows.push([
        les.nivel,
        sesion,
        JSON.stringify(vocab.ej_sv||vocab.ej_en)
      ].join(','));
    });
  });

  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  const totalSesiones = allSessions.length;
  link.download = `curso_sueco_${totalSesiones}_sesiones.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

/* ---------- MODO AUTOM√ÅTICO: 150 sesiones ---------- */
async function runWholeCourse(){
  // Di√°logo para configurar par√°metros
  const nivelInicial = prompt('Nivel inicial (1-25):', '1');
  const nivelFinal = prompt('Nivel final (1-25):', '15');
  const sesionesPorNivel = prompt('N√∫mero de sesiones por nivel:', '1');
  
  // Validar entrada
  if (!nivelInicial || !nivelFinal || !sesionesPorNivel) {
    alert('Operaci√≥n cancelada');
    return;
  }
  
  const inicio = parseInt(nivelInicial);
  const fin = parseInt(nivelFinal);
  const sesiones = parseInt(sesionesPorNivel);
  
  if (isNaN(inicio) || isNaN(fin) || isNaN(sesiones) || 
      inicio < 1 || inicio > 25 || fin < 1 || fin > 25 || 
      inicio > fin || sesiones < 1 || sesiones > 10) {
    alert('Par√°metros inv√°lidos. Niveles: 1-25, Sesiones: 1-10');
    return;
  }
  
  const totalSesiones = (fin - inicio + 1) * sesiones;
  if (!confirm(`¬øEjecutar ${totalSesiones} sesiones autom√°ticamente?\nNiveles: ${inicio}-${fin}\nSesiones por nivel: ${sesiones}`)) return;

  /* --- Reset --- */
  localStorage.removeItem(DICT_KEY);
  localStorage.removeItem(SESSIONS_KEY);
  dictionary   = [];
  allSessions  = [];
  nivel        = inicio;
  localStorage.setItem(LEVEL_KEY, nivel);

  /* --- Variable para controlar el modo debug --- */
  window.isDebugMode = true;
  window.debugSession = 1;
  window.debugLevel = inicio;
  window.debugRunning = true; // Variable para controlar si el debug est√° ejecut√°ndose
  window.debugConfig = { inicio, fin, sesiones }; // Guardar configuraci√≥n

  // Cambiar el bot√≥n a "PARAR Y EXPORTAR"
  handleDebugButton();

  /* --- Funci√≥n recursiva que simula el comportamiento normal --- */
  async function runNextSession() {
    // Verificar si se debe parar el proceso
    if (!window.debugRunning) {
      // Proceso detenido manualmente - exportar CSV
      window.isDebugMode = false;
      setDebugStatus('‚èπÔ∏è Proceso detenido - Descargando CSV...');
      exportAsCSV(allSessions);
      alert(`‚úî Proceso detenido ‚Äì CSV descargado (${allSessions.length} sesiones generadas)`);
      handleDebugButton(); // Restaurar bot√≥n original
      return;
    }
    
    if (window.debugLevel > window.debugConfig.fin) {
      // Terminado - exportar CSV
      window.isDebugMode = false;
      window.debugRunning = false;
      setDebugStatus('‚úÖ Proceso completado - Descargando CSV...');
      exportAsCSV(allSessions);
      const totalSesiones = allSessions.length;
      alert(`‚úî Curso completado ‚Äì CSV descargado (${totalSesiones} sesiones)`);
      handleDebugButton(); // Restaurar bot√≥n original
      return;
    }

    try {
      setDebugStatus(`üîÑ Iniciando Nivel ${window.debugLevel} Sesi√≥n ${window.debugSession}/${window.debugConfig.sesiones}`);
      
      // Simular carga normal de p√°gina
      await generate();
      
      // Simular "Dar por terminada la lecci√≥n"
      if (currentLesson) {
        terminarLeccion(currentLesson);
        setDebugStatus(`‚úÖ Completado Nivel ${window.debugLevel} Sesi√≥n ${window.debugSession}/${window.debugConfig.sesiones}`);
      }
      
      // Preparar siguiente sesi√≥n
      window.debugSession++;
      
      if (window.debugSession > window.debugConfig.sesiones) {
        // Pasar al siguiente nivel
        window.debugSession = 1;
        window.debugLevel++;
        if (window.debugLevel <= window.debugConfig.fin) {
          // Simular "Avanzar nivel"
          nivel = window.debugLevel;
          localStorage.setItem(LEVEL_KEY, nivel);
          levelCurrent.textContent = `${nivel}. ${nivel}. ${levels[nivel-1].descripcion}`;
          setDebugStatus(`üîÑ Avanzando al Nivel ${window.debugLevel}`);
          
          // Asegurar que el vocabulario se guarde antes de cambiar de nivel
          if (currentLesson) {
            let savedWords = 0;
            currentLesson.vocabulario.forEach(w=>{
              if(!dictionary.some(d=>d.sv===w.sv)) {
                dictionary.push({sv:w.sv,es:w.es});
                savedWords++;
              }
            });
            localStorage.setItem(DICT_KEY,JSON.stringify(dictionary));
            console.log(`DEBUG: Avanzando nivel - Palabras guardadas: ${savedWords}, total diccionario: ${dictionary.length}`);
          }
        }
      }
      
      // Continuar con la siguiente sesi√≥n
      setTimeout(runNextSession, 500);
      
    } catch (e) {
      console.error(`Error en Nivel ${window.debugLevel} Sesi√≥n ${window.debugSession}:`, e);
      setDebugStatus(`‚ùå Error Nivel ${window.debugLevel} Sesi√≥n ${window.debugSession} - Continuando...`);
      // Continuar con la siguiente sesi√≥n
      setTimeout(runNextSession, 500);
    }
  }

  // Iniciar el proceso
  runNextSession();
}

// Funci√≥n para parar el debug y exportar
function stopDebugAndExport() {
  if (window.debugRunning) {
    window.debugRunning = false;
    setDebugStatus('‚èπÔ∏è Deteniendo proceso...');
  }
}

// Funci√≥n para manejar el bot√≥n debug
function handleDebugButton() {
  const debugBtn = document.getElementById('dev-run');
  
  if (window.debugRunning) {
    // Si est√° ejecut√°ndose, cambiar a bot√≥n de parar
    debugBtn.textContent = 'PARAR Y EXPORTAR';
    debugBtn.style.background = '#e35353';
    debugBtn.onclick = stopDebugAndExport;
  } else {
    // Si no est√° ejecut√°ndose, iniciar debug
    debugBtn.textContent = 'DEBUG';
    debugBtn.style.background = '';
    debugBtn.onclick = runWholeCourse;
  }
}

// Conectar el bot√≥n oculto RUN 150 con el modo autom√°tico
(function(){
  const debugBtn = document.getElementById('dev-run');
  if (debugBtn) debugBtn.addEventListener('click', runWholeCourse);
})();

/* ---------- Utilidades de texto ---------- */
function decodeEmojis(str) {
  if (typeof str !== 'string') return '';
  const emojiMap = {
    ':)': 'üòä', ':(': 'üòü', 'XD': 'üòÜ', '<3': '‚ù§Ô∏è',
    ':O': 'üòÆ', ';)': 'üòâ', ':P': 'üòã', ':/': 'üòï'
  };
  return str.replace(/:\)|:\(|XD|<3|:O|;\)|:P|:\//g, match => emojiMap[match]);
}
function stripEmojis(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/[\u{1F600}-\u{1F64F}]/gu, '').trim(); // Basic emojis
}

</script>
</body>
</html>
